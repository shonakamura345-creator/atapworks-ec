# 本番モードでの実際のカードを使ったテストと返金手順

## 方針の確認

**本番モードで統一して、実際のカードでテストする方針で進めます。**

メリット：
- ✅ テストモードと本番モードの切り替えが不要
- ✅ 本番環境で実際に動作することを確認できる
- ✅ 返金の手順も実際に確認できる
- ✅ 本番環境での動作を完全に検証できる

---

## テスト手順

### ステップ1: サイトでテスト購入

1. サイト（`https://atapworks.co.jp`）にアクセス
2. 商品をカートに追加
3. カートページに移動
4. 「レジに進む」をクリック

### ステップ2: チェックアウト情報を入力

1. フォームに必要事項を入力：
   - お名前: 任意（例: `テスト 太郎`）
   - メールアドレス: **実際にメールを受信できるメールアドレス**（重要！）
   - 電話番号: 任意（例: `090-1234-5678`）
   - 郵便番号: 任意（例: `100-0001`）
   - 都道府県: 任意（例: `東京都`）
   - 市区町村: 任意（例: `千代田区`）
   - 番地: 任意（例: `千代田1-1-1`）
   - 建物名: 任意（例: `テストビル 101`）

### ステップ3: 実際のカードで決済

1. 「支払い」ボタンをクリック
2. Stripe Checkoutページが表示される
3. **実際のカード情報を入力**：
   - カード番号: 実際のカード番号
   - 有効期限: 実際の有効期限
   - CVC: 実際のCVC
   - 郵便番号: 実際の郵便番号
4. 「支払いを完了」をクリック

⚠️ **注意**: 実際の決済が発生します。テスト後、返金を実行してください。

### ステップ4: 結果を確認

1. **注文完了画面が表示されるか確認**：
   - `https://atapworks.co.jp/checkout/success` にリダイレクトされるか確認
   - 注文完了画面が正しく表示されるか確認

2. **Stripe Dashboardで確認**：
   - Stripe Dashboard → 「取引」タブ
   - 新しい取引が表示されているか確認
   - 取引のステータスが「成功」になっているか確認
   - 取引の詳細を確認（金額、商品など）

3. **Webhookを確認**：
   - Stripe Dashboard → 開発者 → Webhook → エンドポイント → 「最新のイベント」タブ
   - 新しいイベントが表示されているか確認
   - レスポンスコードが `200` になっているか確認

4. **Vercel Dashboardで確認**：
   - Vercel Dashboard → Functions → `/api/webhooks/stripe` を選択
   - ログを確認
   - Webhookが受信されているか確認
   - メール送信のログが表示されているか確認

5. **メールを確認**：
   - **顧客への注文確認メール**: チェックアウトで入力したメールアドレスに届いているか確認
   - **管理者への通知メール**: `info.shokenchikushi@gmail.com` に届いているか確認
   - メールの内容が正しいか確認（注文内容、金額など）

---

## 返金手順

### ステップ1: Stripe Dashboardで取引を確認

1. [Stripe Dashboard](https://dashboard.stripe.com/) にログイン
2. **右上で「本番モード」になっているか確認**
3. 「取引」タブをクリック
4. テストで使用した取引を探す
   - 日時、金額、顧客名などで検索可能
5. 取引をクリックして詳細を確認

### ステップ2: 返金を実行

1. 取引の詳細ページで「**返金**」ボタンをクリック
2. 返金のオプションを選択：
   - **全額返金**: 購入金額全額を返金
   - **部分返金**: 一部のみ返金（テストの場合は全額返金を推奨）
3. 返金理由を選択（オプション）：
   - 「テスト」や「その他」を選択
4. 「返金を処理」または「返金」ボタンをクリック
5. 確認ダイアログで「返金」をクリック

### ステップ3: 返金の確認

1. 取引の詳細ページで返金が処理されたことを確認
2. 取引のステータスが「返金済み」になっているか確認
3. 返金金額が表示されているか確認

### ステップ4: カードへの返金の確認

- 返金は通常、数営業日でカードに反映されます
- カード会社によって異なりますが、通常1-5営業日程度

---

## 返金に関する注意事項

### 返金のタイミング

- ✅ テスト後、すぐに返金を実行することを推奨
- ✅ 返金は取引が完了してから実行可能
- ✅ 返金は通常、数営業日でカードに反映される

### 返金手数料

- Stripeの返金手数料は通常、返金されません
- ただし、返金手数料が発生する場合があります（カード会社によって異なる）

### 返金の確認

- Stripe Dashboardで返金が処理されたことを確認
- カード会社からの通知（メールやアプリ）で返金を確認

---

## テスト後の確認事項

### 正常に動作している場合

- ✅ 注文完了画面が表示される
- ✅ Stripe Dashboard → 取引 → 新しい取引が表示される
- ✅ Stripe Dashboard → Webhook → 最新のイベント → イベントが表示される
- ✅ Vercel Dashboard → Functions → `/api/webhooks/stripe` のログにWebhookが表示される
- ✅ 顧客への注文確認メールが届く
- ✅ 管理者への通知メールが届く

### 問題が発生した場合

- ❌ 注文完了画面が表示されない
- ❌ メールが届かない
- ❌ Webhookが受信されない

上記の問題が発生した場合は、`COMPREHENSIVE_DEBUG.md` を参照してトラブルシューティングしてください。

---

## まとめ

### テスト手順

1. ✅ サイトで商品をカートに追加
2. ✅ チェックアウトページで情報を入力
3. ✅ 実際のカードで決済
4. ✅ 注文完了画面が表示されるか確認
5. ✅ メールが届いているか確認
6. ✅ Webhookが正常に動作しているか確認

### 返金手順

1. ✅ Stripe Dashboard → 取引 → テストで使用した取引を選択
2. ✅ 「返金」ボタンをクリック
3. ✅ 全額返金を選択
4. ✅ 返金を実行
5. ✅ 返金が処理されたことを確認

---

## 注意事項

- ⚠️ 実際の決済が発生します
- ⚠️ テスト後、必ず返金を実行してください
- ⚠️ 返金は通常、数営業日でカードに反映されます
- ⚠️ 返金手数料が発生する場合があります

---

## 次のステップ

テストが成功したら：

1. ✅ 本番環境で正常に動作していることを確認
2. ✅ 実際の顧客が購入できる状態になっている
3. ✅ メール通知が正常に送信される
4. ✅ 返金の手順も確認済み

問題が発生した場合は、トラブルシューティングガイドを参照してください。

