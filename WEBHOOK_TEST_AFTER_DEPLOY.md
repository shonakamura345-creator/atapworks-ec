# 再デプロイ後のWebhookテスト方法

## ✅ 再デプロイ完了

Vercelで再デプロイが完了したら、Webhookが正しく動作するかテストします。

---

## テスト方法

### 方法1: Stripe Dashboardからテスト送信（推奨・簡単）

1. **Stripe Dashboardに移動**
   - [Stripe Dashboard](https://dashboard.stripe.com/) にログイン
   - 「開発者」→「Webhook」をクリック
   - エンドポイント（`adventurous-oasis`）をクリック

2. **テスト送信を実行**
   - 画面の上部にある「**送信をテスト**」ボタンをクリック
   - `checkout.session.completed` を選択
   - 「送信」ボタンをクリック

3. **結果を確認**
   - Stripe Dashboardで「最新のイベント」タブを確認
   - イベントが表示されているか確認
   - レスポンスコードが `200` になっているか確認

4. **Vercelのログを確認**
   - [Vercel Dashboard](https://vercel.com/dashboard) → プロジェクト → 「Functions」タブ
   - `/api/webhooks/stripe` を選択
   - ログを確認

**ログに以下のようなメッセージが表示されれば成功**：
```
📧 顧客への注文確認メールを送信します: ...
✅ 顧客へのメール送信処理が完了しました
📧 管理者への通知メールを送信します
✅ 管理者へのメール送信処理が完了しました
```

---

### 方法2: 実際にテスト購入

1. **サイトでテスト購入**
   - `https://atapworks.co.jp` にアクセス
   - 商品をカートに追加
   - チェックアウトページでテストカードを使用：
     - カード番号: `4242 4242 4242 4242`
     - 有効期限: 未来の日付（例: 12/25）
     - CVC: 任意の3桁（例: 123）
     - 郵便番号: 任意（例: 12345）

2. **購入を完了**
   - フォームに必要事項を入力
   - 「支払い」ボタンをクリック

3. **Webhookを確認**
   - Stripe Dashboard → Webhook → エンドポイント → 「最新のイベント」タブ
   - 新しいイベントが表示されているか確認
   - レスポンスコードが `200` か確認

4. **メールを確認**
   - 顧客メールアドレスに注文確認メールが届いているか確認
   - 管理者メールアドレス（`info.shokenchikushi@gmail.com`）に通知メールが届いているか確認

---

## トラブルシューティング

### 問題1: Webhookが届かない

**確認事項**:
- ✅ Stripe DashboardでエンドポイントURLが正しいか確認
- ✅ Vercelの環境変数 `STRIPE_WEBHOOK_SECRET` が設定されているか確認
- ✅ 再デプロイが完了しているか確認
- ✅ Stripe Dashboardの右上で「本番モード」になっているか確認

### 問題2: 署名検証エラー

**原因**:
- 環境変数 `STRIPE_WEBHOOK_SECRET` の値が間違っている

**解決方法**:
1. Stripe Dashboard → Webhook → エンドポイント → 署名シークレットを再確認
2. Vercelの環境変数が正しい値になっているか確認
3. 値が間違っている場合は、正しい値を設定して再デプロイ

### 問題3: メールが届かない

**確認事項**:
- ✅ Vercelの環境変数に `RESEND_API_KEY` が設定されているか確認
- ✅ Vercelの環境変数に `RESEND_FROM_EMAIL` が設定されているか確認
- ✅ Vercelの環境変数に `ADMIN_EMAIL` が設定されているか確認
- ✅ Vercelのログでエラーが発生していないか確認

---

## チェックリスト

### Stripe Dashboard
- [ ] エンドポイントが作成されている
- [ ] エンドポイントURLが `https://atapworks.co.jp/api/webhooks/stripe` になっている
- [ ] 監視するイベントに `checkout.session.completed` が選択されている
- [ ] テスト送信でイベントが表示される
- [ ] レスポンスコードが `200` になっている

### Vercel
- [ ] 環境変数 `STRIPE_WEBHOOK_SECRET` が設定されている
- [ ] 再デプロイが完了している
- [ ] FunctionsのログにWebhookが表示される
- [ ] ログにエラーが表示されていない

### メール
- [ ] テスト送信後にメールが送信される（ログで確認）
- [ ] 実際の購入後にメールが届く

---

## 次のステップ

テストが成功したら：

1. ✅ Webhookの設定は完了
2. ✅ 本番環境で正常に動作している
3. ✅ 実際の購入でメール通知が送信される

問題が発生した場合は、`WEBHOOK_TROUBLESHOOTING.md` を参照してください。

