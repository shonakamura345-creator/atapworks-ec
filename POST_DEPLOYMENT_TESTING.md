# デプロイ後のテスト方法

## 重要なポイント

**実際に少額で購入する必要はありません！**

Stripeのテストカード（`4242 4242 4242 4242`）を使用すれば、実際の決済は発生せずにテストできます。

本番モードでも、このテストカードは使用可能で、実際の決済は発生しません。

---

## テスト方法

### 方法1: Stripe DashboardからWebhookをテスト（推奨・簡単）

Webhookが正しく動作するか確認する方法です。

#### ステップ1: Stripe Dashboardに移動

1. [Stripe Dashboard](https://dashboard.stripe.com/) にログイン
2. **右上で「本番モード」になっているか確認**
3. 「開発者」→「Webhook」をクリック
4. エンドポイント（`adventurous-oasis` など）をクリック

#### ステップ2: テスト送信を実行

1. ページの上部または右上にある「**送信をテスト**」ボタンをクリック
2. イベントタイプを選択：
   - `checkout.session.completed` を選択
3. 「送信」ボタンをクリック

#### ステップ3: 結果を確認

1. **Stripe Dashboardで確認**：
   - 「最新のイベント」タブを確認
   - イベントが表示されているか確認
   - レスポンスコードが `200` になっているか確認

2. **Vercel Dashboardで確認**：
   - Vercel Dashboard → Functions → `/api/webhooks/stripe` を選択
   - ログを確認
   - 以下のようなログが表示されれば成功：
     ```
     📧 顧客への注文確認メールを送信します: ...
     ✅ 顧客へのメール送信処理が完了しました
     📧 管理者への通知メールを送信します
     ✅ 管理者へのメール送信処理が完了しました
     ```

3. **メールを確認**：
   - 顧客メールアドレス（テスト送信で使用されたメールアドレス）にメールが届いているか確認
   - 管理者メールアドレス（`info.shokenchikushi@gmail.com`）にメールが届いているか確認

---

### 方法2: 実際にテスト購入を実行（推奨・完全なテスト）

実際の購入フロー全体をテストする方法です。

#### ステップ1: サイトでテスト購入

1. サイト（`https://atapworks.co.jp`）にアクセス
2. 商品をカートに追加
3. カートページに移動
4. 「レジに進む」をクリック

#### ステップ2: チェックアウト情報を入力

1. フォームに必要事項を入力：
   - お名前: 任意（例: `テスト 太郎`）
   - メールアドレス: **実際にメールを受信できるメールアドレス**（重要！）
   - 電話番号: 任意（例: `090-1234-5678`）
   - 郵便番号: 任意（例: `100-0001`）
   - 都道府県: 任意（例: `東京都`）
   - 市区町村: 任意（例: `千代田区`）
   - 番地: 任意（例: `千代田1-1-1`）
   - 建物名: 任意（例: `テストビル 101`）

#### ステップ3: テストカードで決済

1. 「支払い」ボタンをクリック
2. Stripe Checkoutページが表示される
3. **テストカード情報を入力**：
   - **カード番号**: `4242 4242 4242 4242`
   - **有効期限**: 未来の日付（例: `12/25`）
   - **CVC**: 任意の3桁（例: `123`）
   - **郵便番号**: 任意（例: `12345`）
4. 「支払いを完了」をクリック

⚠️ **重要**: このテストカードは本番モードでも使用可能で、**実際の決済は発生しません**。

#### ステップ4: 結果を確認

1. **注文完了画面が表示されるか確認**：
   - `https://atapworks.co.jp/checkout/success` にリダイレクトされるか確認
   - 注文完了画面が正しく表示されるか確認

2. **Stripe Dashboardで確認**：
   - Stripe Dashboard → 「取引」タブ
   - 新しい取引が表示されているか確認
   - 取引のステータスが「成功」になっているか確認
   - Stripe Dashboard → Webhook → エンドポイント → 「最新のイベント」タブ
   - 新しいイベントが表示されているか確認
   - レスポンスコードが `200` になっているか確認

3. **Vercel Dashboardで確認**：
   - Vercel Dashboard → Functions → `/api/webhooks/stripe` を選択
   - ログを確認
   - Webhookが受信されているか確認
   - メール送信のログが表示されているか確認

4. **メールを確認**：
   - **顧客への注文確認メール**: チェックアウトで入力したメールアドレスに届いているか確認
   - **管理者への通知メール**: `info.shokenchikushi@gmail.com` に届いているか確認

---

## テストカードについて

### 使用可能なテストカード

Stripeのテストカードは、本番モードでも使用可能で、実際の決済は発生しません。

**推奨テストカード**:
- カード番号: `4242 4242 4242 4242`
- 有効期限: 未来の日付（例: `12/25`）
- CVC: 任意の3桁（例: `123`）
- 郵便番号: 任意（例: `12345`）

**その他のテストカード**:
- 3Dセキュア認証が必要な場合: `4000 0025 0000 3155`
- 決済が失敗する場合: `4000 0000 0000 0002`
- 詳細は [Stripeのテストカード一覧](https://stripe.com/docs/testing) を参照

---

## 確認チェックリスト

### 注文完了画面
- [ ] テスト購入後、注文完了画面（`https://atapworks.co.jp/checkout/success`）が表示される
- [ ] 注文完了画面の内容が正しく表示される

### Stripe
- [ ] Stripe Dashboard → 取引 → 新しい取引が表示される
- [ ] 取引のステータスが「成功」になっている
- [ ] Stripe Dashboard → Webhook → エンドポイント → 「最新のイベント」タブにイベントが表示される
- [ ] イベントのレスポンスコードが `200` になっている

### Vercel
- [ ] Vercel Dashboard → Functions → `/api/webhooks/stripe` のログにWebhookが表示される
- [ ] ログにメール送信のメッセージが表示される（「📧 顧客への注文確認メールを送信します」など）

### メール
- [ ] 顧客への注文確認メールが届く（チェックアウトで入力したメールアドレス）
- [ ] 管理者への通知メールが届く（`info.shokenchikushi@gmail.com`）
- [ ] メールの内容が正しいか確認（注文内容、金額など）

---

## トラブルシューティング

### 問題1: 注文完了画面が表示されない

**確認事項**:
- ✅ 環境変数 `NEXT_PUBLIC_BASE_URL` が `https://atapworks.co.jp` になっているか
- ✅ 環境変数を変更した後、再デプロイしたか
- ✅ ブラウザのコンソール（F12）でエラーがないか

**解決方法**:
1. Vercel Dashboard → Settings → Environment Variables で `NEXT_PUBLIC_BASE_URL` を確認
2. 値が `https://atapworks.co.jp` になっているか確認
3. 間違っている場合は修正して再デプロイ

### 問題2: メールが届かない

**確認事項**:
- ✅ 環境変数 `RESEND_API_KEY` が設定されているか
- ✅ 環境変数 `RESEND_FROM_EMAIL` が設定されているか
- ✅ 環境変数 `ADMIN_EMAIL` が設定されているか
- ✅ Vercel Dashboard → Functions → `/api/webhooks/stripe` のログにエラーがないか
- ✅ Resend Dashboard → Emails でメールが送信されているか

**解決方法**:
1. Vercel Dashboard → Settings → Environment Variables で環境変数を確認
2. Resend Dashboard → Emails でメールの送信状況を確認
3. エラーが表示されている場合、エラーメッセージを確認

### 問題3: Webhookが受信されない

**確認事項**:
- ✅ Stripe DashboardでWebhookエンドポイントが作成されているか
- ✅ エンドポイントURLが `https://atapworks.co.jp/api/webhooks/stripe` になっているか
- ✅ 監視するイベントに `checkout.session.completed` が選択されているか
- ✅ Stripe DashboardのモードとVercelの環境変数 `STRIPE_SECRET_KEY` の形式が一致しているか

**解決方法**:
1. Stripe Dashboard → Webhook → エンドポイントを確認
2. エンドポイントが正しく設定されているか確認
3. テスト送信を実行して、Webhookが受信されるか確認

---

## 次のステップ

テストが成功したら：

1. ✅ 本番環境で正常に動作していることを確認
2. ✅ 実際の顧客が購入できる状態になっている
3. ✅ メール通知が正常に送信される

問題が発生した場合は、上記のトラブルシューティングを参照してください。

---

## まとめ

- ✅ **実際に少額で購入する必要はない**
- ✅ **テストカード（`4242 4242 4242 4242`）を使用すれば、実際の決済は発生しない**
- ✅ **本番モードでもテストカードは使用可能**
- ✅ **まず、Stripe Dashboardからテスト送信を実行**
- ✅ **その後、実際にテスト購入を実行して、完全なフローをテスト**

テストカードを使用すれば、安全にテストできます！

