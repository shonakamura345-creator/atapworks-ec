# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®å†èµ·å‹•æ–¹æ³•

## é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®å†èµ·å‹•æ‰‹é †

### 1. ç¾åœ¨ã®é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ï¼š

1. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
2. `Ctrl + C` ã‚’æŠ¼ã™ï¼ˆMacã®å ´åˆã¯ `Control + C` ã¾ãŸã¯ `Cmd + C`ï¼‰
3. ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã™ã‚‹ã®ã‚’ç¢ºèª

### 2. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•

åŒã˜ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã€ã¾ãŸã¯æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ï¼š

```bash
cd /Users/shonakamura/atapworks-store
npm run dev
```

---

## Webhookãƒ†ã‚¹ãƒˆå¾Œã®ç¢ºèªæ–¹æ³•

### ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ãŸã‚‰

`stripe trigger checkout.session.completed` ã‚’å®Ÿè¡Œã—ãŸå¾Œã€ä»¥ä¸‹ã®æ–¹æ³•ã§ç¢ºèªã§ãã¾ã™ï¼š

### 1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèª

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼š

```
POST /api/webhooks/stripe 200 in XXXms
ðŸ“§ é¡§å®¢ã¸ã®æ³¨æ–‡ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™: ...
âœ… é¡§å®¢ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ
ðŸ“§ ç®¡ç†è€…ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™
âœ… ç®¡ç†è€…ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ
```

### 2. Stripe CLIã®ãƒ­ã‚°ã‚’ç¢ºèª

`stripe listen` ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã€WebhookãŒè»¢é€ã•ã‚ŒãŸã“ã¨ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªï¼š

```
2025-01-XX XX:XX:XX   --> checkout.session.completed [evt_XXXXXX]
2025-01-XX XX:XX:XX  <--  [200] POST http://localhost:3000/api/webhooks/stripe [evt_XXXXXX]
```

---

## ã‚ˆãã‚ã‚‹çŠ¶æ³ã¨å¯¾å‡¦æ³•

### çŠ¶æ³1: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒè¤‡æ•°èµ·å‹•ã—ã¦ã„ã‚‹

**ç—‡çŠ¶**: ãƒãƒ¼ãƒˆ3000ãŒä½¿ç”¨ä¸­ã§ã€ãƒãƒ¼ãƒˆ3001ã§èµ·å‹•ã—ã¦ã—ã¾ã†

**å¯¾å‡¦æ³•**:
1. ã™ã¹ã¦ã®é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ï¼ˆå„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ `Ctrl + C`ï¼‰
2. `.next` ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰:
   ```bash
   rm -rf .next
   ```
3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•:
   ```bash
   npm run dev
   ```

### çŠ¶æ³2: ç’°å¢ƒå¤‰æ•°ãŒèª­ã¿è¾¼ã¾ã‚Œãªã„

**ç—‡çŠ¶**: WebhookãŒå‹•ä½œã—ãªã„ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

**å¯¾å‡¦æ³•**:
1. `.env.local` ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ï¼ˆç’°å¢ƒå¤‰æ•°ã¯èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ï¼‰
3. ãƒ•ã‚¡ã‚¤ãƒ«åãŒ `.env.local` ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆ`.env.local.txt` ãªã©ã§ã¯ãªã„ï¼‰

### çŠ¶æ³3: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸãŒã€ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŽŸå› **:
- é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„
- `stripe listen` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„
- ãƒãƒ¼ãƒˆç•ªå·ãŒä¸€è‡´ã—ã¦ã„ãªã„

**å¯¾å‡¦æ³•**:
1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
2. `stripe listen` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. ãƒãƒ¼ãƒˆç•ªå·ã‚’ç¢ºèªï¼ˆé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒ¼ãƒˆ3001ã§èµ·å‹•ã—ã¦ã„ã‚‹å ´åˆã¯ã€`stripe listen` ã‚‚ãƒãƒ¼ãƒˆ3001ã‚’æŒ‡å®šï¼‰

---

## å®Œå…¨ãªãƒ†ã‚¹ãƒˆæ‰‹é †ï¼ˆã¾ã¨ã‚ï¼‰

### 1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•

```bash
cd /Users/shonakamura/atapworks-store
npm run dev
```

### 2. Stripe CLIã§Webhookã‚’è»¢é€ï¼ˆåˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰

```bash
stripe listen --forward-to localhost:3000/api/webhooks/stripe
```

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€`.env.local` ã«è¿½åŠ ã—ã¾ã™ã€‚

### 3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ï¼ˆç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ï¼‰

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ï¼š
- `Ctrl + C` ã‚’æŠ¼ã—ã¦åœæ­¢
- `npm run dev` ã§å†èµ·å‹•

### 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆåˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰

```bash
stripe trigger checkout.session.completed
```

### 5. ãƒ­ã‚°ã‚’ç¢ºèª

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã€WebhookãŒå—ä¿¡ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã€‚

---

## ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

| æ“ä½œ | ã‚³ãƒžãƒ³ãƒ‰ |
|------|----------|
| é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹• | `npm run dev` |
| é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ | `Ctrl + C` |
| é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹• | `Ctrl + C` â†’ `npm run dev` |
| Webhookã‚’è»¢é€ | `stripe listen --forward-to localhost:3000/api/webhooks/stripe` |
| ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ | `stripe trigger checkout.session.completed` |

