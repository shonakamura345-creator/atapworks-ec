# 本番モード（ライブモード）でのテスト方法

## 重要なポイント

**本番モード（ライブモード）では、テストカード（`4242 4242 4242 4242`）は使用できません。**

テストカードは**テストモード専用**です。

---

## 選択肢

### オプション1: テストモードでテストする（推奨）

本番モードで統一したい場合でも、まずテストモードでテストしてから本番モードに切り替えることを推奨します。

**メリット**:
- ✅ テストカードが使用できる
- ✅ 実際の決済が発生しない
- ✅ 安全にテストできる
- ✅ 問題がなければ、本番モードに切り替えるだけ

**手順**:
1. Stripe Dashboardをテストモードに切り替え
2. テストモードでWebhookエンドポイントを作成
3. テストカードでテスト購入を実行
4. すべて正常に動作することを確認
5. 本番モードに切り替え
6. 本番モードでWebhookエンドポイントを作成
7. 本番キーに更新

---

### オプション2: 本番モードで実際のカードを使用する（注意が必要）

本番モードでテストする場合、実際のカードを使用する必要があります。

⚠️ **注意**: 実際の決済が発生します。テスト後、返金する必要があります。

**メリット**:
- ✅ 本番環境で実際に動作することを確認できる

**デメリット**:
- ❌ 実際の決済が発生する
- ❌ テスト後、返金する必要がある
- ❌ 手数料が発生する可能性がある

**手順**:
1. 実際のカードで購入を実行
2. 注文完了画面が表示されるか確認
3. メールが届いているか確認
4. テスト後、Stripe Dashboard → 取引 → 返金を実行

---

## 推奨される手順

### ステップ1: テストモードでテスト（推奨）

1. **Stripe Dashboardをテストモードに切り替え**
   - Stripe Dashboardの右上で「テストモード」をクリック

2. **テストモードでWebhookエンドポイントを作成**
   - Stripe Dashboard → 開発者 → Webhook
   - 「送信先を追加する」をクリック
   - エンドポイントURL: `https://atapworks.co.jp/api/webhooks/stripe`
   - 監視するイベント: `checkout.session.completed` を選択
   - 署名シークレットを取得

3. **Vercelの環境変数をテストキーに一時的に変更**
   - Vercel Dashboard → Settings → Environment Variables
   - `STRIPE_SECRET_KEY` をテストキー（`sk_test_...`）に変更
   - `STRIPE_WEBHOOK_SECRET` をテストモードのWebhook署名シークレットに変更
   - 再デプロイ

4. **テストカードでテスト購入を実行**
   - カード番号: `4242 4242 4242 4242`
   - 有効期限: 未来の日付
   - CVC: 任意の3桁
   - 郵便番号: 任意

5. **結果を確認**
   - 注文完了画面が表示されるか確認
   - メールが届いているか確認
   - Webhookが正常に動作しているか確認

6. **すべて正常に動作することを確認**

### ステップ2: 本番モードに切り替え

テストが成功したら、本番モードに切り替えます：

1. **Stripe Dashboardを本番モードに切り替え**
   - Stripe Dashboardの右上で「本番モード」をクリック

2. **本番モードでWebhookエンドポイントを作成**
   - Stripe Dashboard → 開発者 → Webhook
   - 「送信先を追加する」をクリック
   - エンドポイントURL: `https://atapworks.co.jp/api/webhooks/stripe`
   - 監視するイベント: `checkout.session.completed` を選択
   - 署名シークレットを取得

3. **Vercelの環境変数を本番キーに更新**
   - Vercel Dashboard → Settings → Environment Variables
   - `STRIPE_SECRET_KEY` を本番キー（`sk_live_...`）に変更
   - `STRIPE_WEBHOOK_SECRET` を本番モードのWebhook署名シークレットに変更
   - 再デプロイ

4. **本番モードで動作確認**
   - Stripe Dashboard → Webhook → エンドポイント → 「送信をテスト」でテスト
   - または、実際のカードで少額の購入をテスト（テスト後、返金）

---

## 本番モードで実際のカードを使用する場合

⚠️ **注意**: 実際の決済が発生します。

### 手順

1. **実際のカードで購入を実行**
   - サイトで商品をカートに追加
   - チェックアウトページで実際のカード情報を入力
   - 購入を完了

2. **結果を確認**
   - 注文完了画面が表示されるか確認
   - メールが届いているか確認
   - Webhookが正常に動作しているか確認

3. **テスト後、返金を実行**
   - Stripe Dashboard → 「取引」タブ
   - テストで使用した取引を選択
   - 「返金」をクリック
   - 返金を実行

---

## まとめ

### 推奨される方法

1. ✅ **まず、テストモードでテスト**
   - テストカードを使用
   - 実際の決済は発生しない
   - 安全にテストできる

2. ✅ **テストが成功したら、本番モードに切り替え**
   - 本番モードでWebhookエンドポイントを作成
   - 本番キーに更新
   - 本番モードで動作確認

### 本番モードでテストする場合

- ⚠️ **実際のカードを使用する必要がある**
- ⚠️ **実際の決済が発生する**
- ⚠️ **テスト後、返金する必要がある**

---

## 結論

**まず、テストモードでテストすることを強く推奨します。**

理由：
- テストカードが使用できる
- 実際の決済が発生しない
- 安全にテストできる
- 問題がなければ、本番モードに切り替えるだけ

テストモードでテストが成功したら、本番モードに切り替えて、本番環境で動作することを確認してください。

