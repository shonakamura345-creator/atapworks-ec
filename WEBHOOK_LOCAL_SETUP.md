# ローカル環境でのWebhook設定（現在の状況）

## ✅ 完了したこと

Stripe CLIが正常に動作しています。以下のシークレットが表示されています：

```
whsec_b9885a6ae04adac2d98a9854144a83b8d1cf7716b05a811a4186bb31efdf8968
```

---

## 次のステップ

### 1. `.env.local` ファイルにシークレットを追加

`.env.local` ファイルを開いて、以下の行を追加してください：

```env
STRIPE_WEBHOOK_SECRET=whsec_b9885a6ae04adac2d98a9854144a83b8d1cf7716b05a811a4186bb31efdf8968
```

**注意**: 
- `.env.local` ファイルが存在しない場合は、プロジェクトのルートディレクトリに作成してください
- 既に `STRIPE_WEBHOOK_SECRET` が設定されている場合は、この値に置き換えてください

### 2. 開発サーバーを再起動

環境変数を追加した後、開発サーバーを再起動してください：

```bash
# 現在の開発サーバーを停止（Ctrl+C）
# その後、再起動
npm run dev
```

### 3. テスト

Webhookが正しく動作するかテストします：

```bash
# 別のターミナルで実行（Stripe CLIが既に起動している状態）
stripe trigger checkout.session.completed
```

開発サーバーのログに、Webhookが受信されたことが表示されるはずです。

---

## 現在の状態

✅ Stripe CLIが動作中（`stripe listen` が実行中）
✅ Webhook署名シークレットが取得済み
⏳ `.env.local` にシークレットを追加する必要がある
⏳ 開発サーバーの再起動が必要

---

## 確認方法

### 開発サーバーのログで確認

Webhookが正常に受信されると、以下のようなログが表示されます：

```
📧 顧客への注文確認メールを送信します: ...
✅ 顧客へのメール送信処理が完了しました
📧 管理者への通知メールを送信します
✅ 管理者へのメール送信処理が完了しました
```

### Stripe CLIで確認

Stripe CLIが実行されているターミナルで、Webhookが転送されたことが表示されます。

---

## トラブルシューティング

### 開発サーバーがポート3000で起動していない場合

もし開発サーバーがポート3001で起動している場合は、Stripe CLIのコマンドを以下のように変更してください：

```bash
stripe listen --forward-to localhost:3001/api/webhooks/stripe
```

そして、新しいシークレットが表示されるので、それを `.env.local` に追加してください。

### 環境変数が読み込まれない場合

1. `.env.local` ファイルが正しい場所（プロジェクトのルートディレクトリ）にあるか確認
2. ファイル名が `.env.local` であることを確認（`.env.local.txt` などではない）
3. 開発サーバーを再起動したか確認

---

## 次のステップ（ローカル環境の設定が完了したら）

ローカル環境でのWebhook設定が完了したら、デプロイ先（Vercel）での設定に進みます。

詳細は `WEBHOOK_SETUP_GUIDE.md` を参照してください。

