# 本番モードでテストカードを使用したエラー

## エラー内容

```
Your card was declined. Your request was in live mode, but used a known test card.
```

## 原因

本番モード（live mode）でテストカード（`4242...`）を使用しようとしたため、決済が拒否されました。

**重要なポイント**:
- テストカード（`4242...`）は**テストモード**でのみ使用可能
- **本番モード**では、**実際のカード**を使用する必要がある
- 本番モードでテストカードを使用すると、このエラーが発生する

---

## 解決方法

### オプション1: 本番モードで実際のカードを使用（推奨）

本番モードでテストする場合は、**実際のカード**を使用してください。

**手順**:
1. サイト（`https://atapworks.co.jp`）でテスト購入を実行
2. チェックアウトページで、**実際のカード情報**を入力
3. 決済を完了
4. テスト後、Stripe Dashboardで返金を実行

**注意事項**:
- 実際の決済が発生します
- テスト後、必ず返金を実行してください
- 少額（例: 100円）でテストすることを推奨

---

### オプション2: テストモードに切り替える（テスト用）

テストカードを使用したい場合は、**テストモード**に切り替えてください。

**手順**:
1. Stripe Dashboardの右上で「テストモード」に切り替え
2. Vercel Dashboard → Settings → Environment Variables で、以下の環境変数をテストキーに変更：
   - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` → `pk_test_...`
   - `STRIPE_SECRET_KEY` → `sk_test_...`
   - `STRIPE_WEBHOOK_SECRET` → テストモードのWebhookシークレット
3. 再デプロイ
4. テストカード（`4242 4242 4242 4242`）でテスト購入を実行

**注意事項**:
- テストモードでは実際の決済は発生しません
- テスト後、本番モードに戻す必要があります

---

## なぜWebhookのログが表示されないのか

**理由**: 決済が完了していないため、Webhookイベント（`checkout.session.completed`）が発生していません。

**Webhookイベントが発生する条件**:
- ✅ 決済が正常に完了した場合
- ❌ 決済が拒否された場合（今回のケース）
- ❌ 決済がキャンセルされた場合

今回のエラーでは、決済が拒否されているため、Webhookイベントは発生していません。

---

## 次のステップ

### 本番モードで実際のカードを使用する場合

1. **実際のカード情報を入力**して決済を完了
2. **決済が完了したら**、Webhookイベントが発生します
3. **Vercel Dashboardのログ**でWebhookの処理を確認
4. **メールが届くか確認**
5. **テスト後、Stripe Dashboardで返金を実行**

### テストモードに切り替える場合

1. **Stripe Dashboardでテストモードに切り替え**
2. **Vercel Dashboardの環境変数をテストキーに変更**
3. **再デプロイ**
4. **テストカードでテスト購入を実行**
5. **テスト後、本番モードに戻す**

---

## まとめ

- ❌ **本番モードでテストカードを使用** → エラーが発生（今回のケース）
- ✅ **本番モードで実際のカードを使用** → 正常に動作（推奨）
- ✅ **テストモードでテストカードを使用** → 正常に動作（テスト用）

**本番モードでテストする場合は、実際のカードを使用してください。**

テスト後、必ず返金を実行してください。

