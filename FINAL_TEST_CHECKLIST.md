# 最終テスト前の確認チェックリスト

## ✅ 完了したこと

- ✅ コードのデプロイ（Ready状態）
- ✅ Stripe APIバージョンを `2025-11-17.clover` に更新
- ✅ 型エラーを修正

---

## ⏳ テスト前に確認すべきこと

### 1. Stripe Dashboardで新しいWebhookエンドポイントを作成（重要）

既存のWebhookエンドポイントを削除し、新しいエンドポイントを作成してください。

**手順**:
1. [Stripe Dashboard](https://dashboard.stripe.com/) → 「開発者」→「Webhook」
2. 既存のエンドポイントを削除（オプション）
3. 「イベントの送信先を作成する」をクリック
4. 以下の情報を入力：
   - **イベントを選択**: `checkout.session.completed`
   - **エンドポイントURL**: `https://atapworks.co.jp/api/webhooks/stripe`
   - **APIバージョン**: `2025-11-17.clover` を選択（重要！）
5. 「送信先を作成する」をクリック
6. **Webhookシークレットをコピー**（`whsec_...` で始まる）

### 2. Vercelの環境変数を更新

新しいWebhookシークレットをVercelの環境変数に設定してください。

**手順**:
1. [Vercel Dashboard](https://vercel.com/dashboard) → プロジェクト → Settings → Environment Variables
2. `STRIPE_WEBHOOK_SECRET` を探す
3. 「編集」をクリック
4. 新しいWebhookシークレットを貼り付け
5. 「Save」をクリック
6. **再デプロイ**（重要！）

---

## テスト手順

### ステップ1: サイトでテスト購入を実行

1. サイト（`https://atapworks.co.jp`）にアクセス
2. 商品をカートに追加
3. カートページに移動
4. 「レジに進む」をクリック

### ステップ2: チェックアウト情報を入力

1. フォームに必要事項を入力：
   - お名前: 任意（例: `テスト 太郎`）
   - メールアドレス: **実際にメールを受信できるメールアドレス**（重要！）
   - 電話番号: 任意（例: `090-1234-5678`）
   - 郵便番号: 任意（例: `100-0001`）
   - 都道府県: 任意（例: `東京都`）
   - 市区町村: 任意（例: `千代田区`）
   - 番地: 任意（例: `千代田1-1-1`）
   - 建物名: 任意（例: `テストビル 101`）

### ステップ3: 実際のカードで決済

⚠️ **重要**: 本番モードでは、**実際のカード**を使用する必要があります。テストカード（`4242...`）は使用できません。

1. 「支払い」ボタンをクリック
2. Stripe Checkoutページが表示される
3. **実際のカード情報を入力**：
   - カード番号: 実際のカード番号
   - 有効期限: 実際の有効期限
   - CVC: 実際のCVC
   - 郵便番号: 実際の郵便番号
4. 「支払いを完了」をクリック

⚠️ **注意**: 実際の決済が発生します。テスト後、返金を実行してください。

### ステップ4: 結果を確認

#### 4-1. 注文完了画面が表示されるか確認

- ✅ 注文完了画面が表示される → 正常
- ❌ 注文完了画面が表示されない → 問題あり

#### 4-2. Stripe Dashboardで確認

1. [Stripe Dashboard](https://dashboard.stripe.com/) → 「開発者」→「Webhook」
2. エンドポイントをクリック
3. 「最新のイベント」タブを確認
4. イベントが表示されているか確認
5. レスポンスコードが `200` か確認

#### 4-3. Vercel Dashboardでログを確認

1. [Vercel Dashboard](https://vercel.com/dashboard) → プロジェクト
2. 「Deployments」タブ → 最新のデプロイメントをクリック
3. 「Functions」タブ → `/api/webhooks/stripe` を選択
4. ログを確認

**確認すべきログ**:
```
POST /api/webhooks/stripe
📧 顧客への注文確認メールを送信します:
  顧客メールアドレス: [メールアドレス]
  RESEND_API_KEY: re_xxxxx...
✅ メール送信成功: {"id":"..."}
✅ 顧客へのメール送信処理が完了しました
📧 管理者への通知メールを送信します
✅ 管理者通知メール送信成功: {"id":"..."}
✅ 管理者へのメール送信処理が完了しました
```

#### 4-4. メールの受信確認

1. 顧客のメールアドレスでメールが届いているか確認
2. 管理者のメールアドレス（`info.shokenchikushi@gmail.com`）でメールが届いているか確認
3. 迷惑メールフォルダも確認

### ステップ5: 返金を実行（テスト後）

1. [Stripe Dashboard](https://dashboard.stripe.com/) → 「取引」
2. テストで使用した取引を選択
3. 「返金」ボタンをクリック
4. 全額返金を選択
5. 返金を実行
6. 返金が処理されたことを確認

---

## まとめ

### テスト前に必須

1. ⏳ **Stripe Dashboardで新しいWebhookエンドポイントを作成**（APIバージョン: `2025-11-17.clover`）
2. ⏳ **WebhookシークレットをVercelの環境変数に設定**
3. ⏳ **再デプロイ**

### テスト手順

1. ⏳ **サイトでテスト購入を実行**
2. ⏳ **実際のカードで決済**（重要！）
3. ⏳ **結果を確認**（注文完了画面、ログ、メール）
4. ⏳ **返金を実行**

---

## 重要な注意事項

- ⚠️ **本番モードでは、実際のカードを使用する必要があります**
- ⚠️ **テストカード（`4242...`）は使用できません**
- ⚠️ **実際の決済が発生します**
- ⚠️ **テスト後、必ず返金を実行してください**

まず、**Stripe Dashboardで新しいWebhookエンドポイントを作成**してから、テストを実行してください。

