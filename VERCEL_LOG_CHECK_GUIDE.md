# Vercelログの確認方法（詳細ガイド）

## メールが届かない問題を解決するために

Vercel Dashboardのログを確認して、メール送信処理の状況を詳しく調べます。

---

## ステップ1: Vercel Dashboardにアクセス

1. [Vercel Dashboard](https://vercel.com/dashboard) にログイン
2. プロジェクト（`atapworks-store` など）を選択

---

## ステップ2: Functionsタブを開く

1. プロジェクトページで「**Functions**」タブをクリック
2. 左側のリストから「**`/api/webhooks/stripe`**」を選択

---

## ステップ3: ログを確認

### 3-1. 最新のログを確認

ログの一覧が表示されます。最新のログ（購入直後のログ）を確認してください。

### 3-2. 確認すべきログメッセージ

#### ✅ 正常な場合のログ

以下のようなログが表示されているはずです：

```
POST /api/webhooks/stripe
📧 顧客への注文確認メールを送信します:
  顧客メールアドレス: [メールアドレス]
  顧客名: [お名前]
  注文ID: [セッションID]
  注文アイテム数: [数]
  合計金額: [金額]
📧 Resendでメールを送信します:
  From: onboarding@resend.dev
  To: [メールアドレス]
  Subject: ご注文ありがとうございます - Sho建築士オンラインストア
  RESEND_API_KEY: re_xxxxx...
  RESEND_FROM_EMAIL: onboarding@resend.dev
✅ メール送信成功: {"id":"..."}
✅ メールID: [メールID]
✅ 顧客へのメール送信処理が完了しました
📧 管理者への通知メールを送信します
  管理者メールアドレス: info.shokenchikushi@gmail.com
  顧客メールアドレス: [メールアドレス]
  注文ID: [セッションID]
📧 Resendで管理者通知メールを送信します:
  From: onboarding@resend.dev
  To: info.shokenchikushi@gmail.com
  Subject: 🛒 新しい注文が入りました - 注文ID: [セッションID]
  RESEND_API_KEY: re_xxxxx...
  RESEND_FROM_EMAIL: onboarding@resend.dev
  ADMIN_EMAIL: info.shokenchikushi@gmail.com
✅ 管理者通知メール送信成功: {"id":"..."}
✅ メールID: [メールID]
✅ 管理者へのメール送信処理が完了しました
```

#### ❌ エラーが発生している場合のログ

以下のようなエラーログが表示される可能性があります：

**パターン1: RESEND_API_KEYが設定されていない**
```
⚠️ RESEND_API_KEYが設定されていません。メールは送信されません。
📧 メール送信（開発モード）:
送信先: [メールアドレス]
件名: ご注文ありがとうございます
注文ID: [セッションID]
```

**パターン2: ADMIN_EMAILが設定されていない**
```
⚠️ ADMIN_EMAILが設定されていません。管理者通知は送信されません。
```

**パターン3: Resend APIエラー**
```
❌ Resendメール送信エラー: {"message":"...","name":"..."}
❌ エラーの種類: [エラー種類]
❌ エラーメッセージ: [エラーメッセージ]
```

**パターン4: Webhookが届いていない**
```
（ログに何も表示されない、または古いログしか表示されない）
```

---

## ステップ4: ログの内容を分析

### 4-1. Webhookが届いているか確認

- ✅ ログに `POST /api/webhooks/stripe` が表示されている → Webhookは届いている
- ❌ ログに何も表示されない → Webhookが届いていない可能性

**Webhookが届いていない場合**：
- Stripe Dashboard → Webhook → エンドポイント → 「最新のイベント」タブを確認
- イベントが表示されていない場合、Webhookエンドポイントの設定を確認

### 4-2. 環境変数が設定されているか確認

ログに以下のメッセージが表示されているか確認：

- ✅ `RESEND_API_KEY: re_xxxxx...` → 環境変数が設定されている
- ❌ `RESEND_API_KEY: 未設定` → 環境変数が設定されていない

**環境変数が設定されていない場合**：
- Vercel Dashboard → Settings → Environment Variables で環境変数を確認
- 不足している環境変数を追加
- 環境変数を変更した後、再デプロイ

### 4-3. メール送信処理が実行されているか確認

ログに以下のメッセージが表示されているか確認：

- ✅ `📧 Resendでメールを送信します:` → メール送信処理が実行されている
- ❌ このメッセージが表示されない → メール送信処理が実行されていない

**メール送信処理が実行されていない場合**：
- `RESEND_API_KEY` が設定されていない可能性
- コードの実行フローに問題がある可能性

### 4-4. メール送信が成功しているか確認

ログに以下のメッセージが表示されているか確認：

- ✅ `✅ メール送信成功:` → メール送信が成功している
- ❌ `❌ Resendメール送信エラー:` → メール送信でエラーが発生している

**メール送信でエラーが発生している場合**：
- エラーメッセージの内容を確認
- Resend Dashboard → Emails でメールの送信状況を確認

---

## ステップ5: ログをスクリーンショットまたはコピー

問題を特定するために、ログの内容をスクリーンショットまたはコピーして共有してください。

特に以下の情報が重要です：

1. **Webhookが届いているか**（`POST /api/webhooks/stripe` が表示されているか）
2. **環境変数の状態**（`RESEND_API_KEY`、`RESEND_FROM_EMAIL`、`ADMIN_EMAIL` が表示されているか）
3. **メール送信処理の実行状況**（`📧 Resendでメールを送信します:` が表示されているか）
4. **エラーメッセージ**（`❌` で始まるメッセージがあれば、その内容）

---

## よくある問題と解決方法

### 問題1: Webhookが届いていない

**症状**: ログに `POST /api/webhooks/stripe` が表示されない

**解決方法**:
1. Stripe Dashboard → Webhook → エンドポイント → 「最新のイベント」タブを確認
2. イベントが表示されていない場合、Webhookエンドポイントの設定を確認
3. エンドポイントURLが `https://atapworks.co.jp/api/webhooks/stripe` になっているか確認

---

### 問題2: RESEND_API_KEYが設定されていない

**症状**: ログに `⚠️ RESEND_API_KEYが設定されていません` が表示される

**解決方法**:
1. Vercel Dashboard → Settings → Environment Variables
2. `RESEND_API_KEY` を追加（値: `re_...` で始まる文字列）
3. Environment: Production にチェック
4. 再デプロイ

---

### 問題3: Resend APIエラー

**症状**: ログに `❌ Resendメール送信エラー:` が表示される

**解決方法**:
1. エラーメッセージの内容を確認
2. Resend Dashboard → API Keys でAPIキーが有効か確認
3. Resend Dashboard → Emails でメールの送信状況を確認
4. 必要に応じて、Resend APIキーを再生成

---

### 問題4: メール送信は成功しているが届かない

**症状**: ログに `✅ メール送信成功:` が表示されるが、メールが届かない

**解決方法**:
1. Resend Dashboard → Emails でメールが送信されているか確認
2. メールアドレスが正しいか確認
3. 迷惑メールフォルダを確認
4. メールアドレスのドメインが正しいか確認

---

## 次のステップ

ログを確認したら、以下の情報を共有してください：

1. **Webhookが届いているか**（`POST /api/webhooks/stripe` が表示されているか）
2. **環境変数の状態**（ログに表示されている環境変数の値）
3. **メール送信処理の実行状況**（どのログメッセージが表示されているか）
4. **エラーメッセージ**（エラーが発生している場合、その内容）

これらの情報があれば、より具体的な解決方法を提案できます。

